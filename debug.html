<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Storage Test</title>
  <style>
    body { font-family: system-ui; padding: 20px; max-width: 600px; margin: 0 auto; }
    .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    .success { background: #e8f5e9; border-color: #4caf50; }
    .error { background: #ffebee; border-color: #f44336; }
    button { padding: 8px 16px; margin: 5px; cursor: pointer; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    input { padding: 8px; width: 200px; margin-right: 10px; }
  </style>
</head>
<body>
  <h1>üîç CP Tracker Storage Debug</h1>
  
  <div class="test">
    <h3>1. Chrome Storage API Test</h3>
    <button onclick="testStorageAPI()">Test Storage API</button>
    <div id="apiResult"></div>
  </div>

  <div class="test">
    <h3>2. Save Test Config</h3>
    <input type="text" id="testUsername" placeholder="Enter test username" value="tourist">
    <button onclick="saveTestConfig()">Save Config</button>
    <div id="saveResult"></div>
  </div>

  <div class="test">
    <h3>3. Load Config</h3>
    <button onclick="loadConfig()">Load Config</button>
    <div id="loadResult"></div>
  </div>

  <div class="test">
    <h3>4. View All Storage</h3>
    <button onclick="viewAllStorage()">View Storage</button>
    <div id="storageResult"></div>
  </div>

  <div class="test">
    <h3>5. Clear Storage</h3>
    <button onclick="clearStorage()">Clear All Data</button>
    <div id="clearResult"></div>
  </div>

  <script type="module">
    import StorageManager from './utils/storage.js';

    window.testStorageAPI = function() {
      const result = document.getElementById('apiResult');
      if (typeof chrome !== 'undefined' && chrome.storage) {
        result.innerHTML = '<p class="success">‚úÖ Chrome Storage API is available</p>';
        console.log('Chrome storage:', chrome.storage);
      } else {
        result.innerHTML = '<p class="error">‚ùå Chrome Storage API NOT available</p>';
      }
    };

    window.saveTestConfig = async function() {
      const result = document.getElementById('saveResult');
      const username = document.getElementById('testUsername').value;
      
      try {
        result.innerHTML = '<p>Saving...</p>';
        
        const config = {
          usernames: {
            codeforces: username,
            leetcode: '',
            atcoder: '',
            codechef: '',
            hackerrank: '',
            cses: '',
            spoj: '',
            topcoder: '',
            uva: '',
            geeksforgeeks: ''
          },
          settings: {
            auto_sync_frequency: '6h',
            notifications_enabled: true,
            theme: 'dark',
            comparison_timeframes: ['7d', '30d', '90d', 'all'],
            default_view: 'dashboard'
          }
        };
        
        console.log('Saving config:', config);
        await StorageManager.setConfig(config);
        
        result.innerHTML = '<p class="success">‚úÖ Config saved successfully!</p>';
        
        // Verify
        const saved = await StorageManager.getConfig();
        console.log('Verified saved config:', saved);
        
      } catch (error) {
        console.error('Save error:', error);
        result.innerHTML = '<p class="error">‚ùå Error: ' + error.message + '</p>';
      }
    };

    window.loadConfig = async function() {
      const result = document.getElementById('loadResult');
      
      try {
        result.innerHTML = '<p>Loading...</p>';
        
        const config = await StorageManager.getConfig();
        console.log('Loaded config:', config);
        
        if (config) {
          result.innerHTML = '<p class="success">‚úÖ Config loaded!</p><pre>' + 
            JSON.stringify(config, null, 2) + '</pre>';
        } else {
          result.innerHTML = '<p class="error">‚ùå No config found</p>';
        }
        
      } catch (error) {
        console.error('Load error:', error);
        result.innerHTML = '<p class="error">‚ùå Error: ' + error.message + '</p>';
      }
    };

    window.viewAllStorage = function() {
      const result = document.getElementById('storageResult');
      
      chrome.storage.local.get(null, (items) => {
        console.log('All storage:', items);
        result.innerHTML = '<p class="success">‚úÖ Storage contents (see console)</p><pre>' + 
          JSON.stringify(items, null, 2) + '</pre>';
      });
    };

    window.clearStorage = async function() {
      const result = document.getElementById('clearResult');
      
      if (confirm('Clear all extension data?')) {
        try {
          await StorageManager.clearAllData();
          result.innerHTML = '<p class="success">‚úÖ All data cleared</p>';
        } catch (error) {
          result.innerHTML = '<p class="error">‚ùå Error: ' + error.message + '</p>';
        }
      }
    };

    // Auto-test on load
    console.log('Test page loaded');
    testStorageAPI();
  </script>
</body>
</html>
